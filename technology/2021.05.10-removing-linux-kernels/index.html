<!doctype html><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name=description content="The blog of Kenny Robinson"><meta name=author content="Kenny Robinson, @almostengr"><meta name=generator content=Mkdocs><title>Removing Linux Kernels - The Almost Engineer</title><link href=/assets/dist/css/bootstrap.min.css rel=stylesheet><link href=/css/blog.min.css rel=stylesheet><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:site_name content="The Almost Engineer"><meta name=twitter:card content=summary><meta name=twitter:site content><meta name=twitter:creator content><meta name=description content="When the kernels are left on your Linux system, they can take up unnecessary disk space. Thus they should be removed when no longer used."><meta property=og:description content="When the kernels are left on your Linux system, they can take up unnecessary disk space. Thus they should be removed when no longer used."><meta name=twitter:description content="When the kernels are left on your Linux system, they can take up unnecessary disk space. Thus they should be removed when no longer used."><meta name=keywords content="linux, ubuntu, removing kernel, linux kernel, ubuntu kernel, old kernels"><meta name=robots content="index, follow"><link href=https://thealmostengineer.com/technology/2021.05.10-removing-linux-kernels/ rel=canonical><meta content=https://thealmostengineer.com/technology/2021.05.10-removing-linux-kernels/ property=og:url><meta content=https://thealmostengineer.com/technology/2021.05.10-removing-linux-kernels/ property=twitter:url><meta name=author content="Kenny Robinson"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="//www.googletagmanager.com/gtag/js?id="></script><script async>window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-64643711-1');</script></head> <body class=bg-dark> <nav class="navbar navbar-expand-md navbar-dark bg-dark pb-2"> <a href=/ class=navbar-brand>The Almost Engineer</a> <button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation"> <span class=navbar-toggler-icon></span> </button> <div class="collapse navbar-collapse" id=navbarCollapse> <ul class="navbar-nav mr-auto"> <li class=nav-item><a class="nav-link text-light" href=/technology>Technology</a></li> <li class=nav-item><a class="nav-link text-light" href=/lifestyle>Living</a></li> <li class=nav-item><a class="nav-link text-light" href=/projects>Projects</a></li> <li class=nav-item><a class="nav-link text-light" href=/resources>Resources</a></li> <li class=nav-item><a class="nav-link text-light" href=https://lightshow.thealmostengineer.com>Light Show</a></li> </ul> <form class="form-inline mt-2 mt-md-0" action=https://www.google.com/search method=get> <input type=hidden name=q value=site:thealmostengineer.com> <input class="form-control mr-sm-2" type=text placeholder="Search with Google" aria-label=Search name=q> </form> </div> </nav> <div class="bg-light pt-3 mb-0 pb-0"> <main role=main class=container> <div class=row> <div class="col-md-8 blog-main"> <h1>Removing Linux Kernels</h1> <h2 id=problem>Problem</h2> <p>I noticed that I could not connect to one of my virutal machines (VM). I have a script that checks to see if the machines were offline and if so it will start them. Thus I did some investigating. What I found was not what I was expecting. </p> <p>The VM in question was in fact showing as running in the VirtualBox. What happened was that it had attempted to upgrade to the next version of the Linux kernel. Only problem was that it ran out of space when unpackaging the archive. Thus I had to remove the existing kernels on the disk before it would continue. Here's how I did it. </p> <h2 id=find-the-old-kernels>Find The Old Kernels</h2> <p>You need to find the existing kernels on the system. Since this was not my first time cleaning up the file system, I created a shell script that I can use that will display the kernels that are installed on the system. </p> <h3 id=the-script>The Script</h3> <pre><code class=language-bash>#!/bin/bash

################################################################################
# author: Kenny Robinson, @almostengr
# Description: List the linux kernels that are installed on a system. Use in 
# conjunction with removing old and unused kernels. 
# https://thealmostengineer.com/technology/2021.05.10-removing-linux-kernels/
################################################################################

dpkg -l | tail -n +6 | grep -E 'linux-image-[0-9]+' | grep -Fv $(uname -r)
</code></pre> <p>When you run the script, it will give you an output like the following: </p> <pre><code class=language-bash>iamadmin@thepost:~/ubuntu-automation/utils$ . list_linux_kernels.sh 
rc  linux-image-4.15.0-101-generic         4.15.0-101.102                                  amd64        Signed kernel image generic
rc  linux-image-4.15.0-106-generic         4.15.0-106.107                                  amd64        Signed kernel image generic
rc  linux-image-4.15.0-108-generic         4.15.0-108.109                                  amd64        Signed kernel image generic
ii  linux-image-4.15.0-111-generic         4.15.0-111.112                                  amd64        Signed kernel image generic
rc  linux-image-4.15.0-34-generic          4.15.0-34.37                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-38-generic          4.15.0-38.41                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-39-generic          4.15.0-39.42                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-42-generic          4.15.0-42.45                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-43-generic          4.15.0-43.46                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-46-generic          4.15.0-46.49                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-47-generic          4.15.0-47.50                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-50-generic          4.15.0-50.54                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-51-generic          4.15.0-51.55                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-54-generic          4.15.0-54.58                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-58-generic          4.15.0-58.64                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-88-generic          4.15.0-88.88                                    amd64        Signed kernel image generic
rc  linux-image-4.15.0-99-generic          4.15.0-99.100                                   amd64        Signed kernel image generic
</code></pre> <p>The break down of the output is as follows. </p> <ul> <li>Lines that begin with "rc" are the ones that can be removed without any problem.</li> <li>Lines that begin with "ii" should not be removed as they are being used by the system.</li> <li>The second column of the output, represents the name of the image. This is what you will use in the next section to remove the old kernels from the system.</li> </ul> <h2 id=remove-the-old-kernels>Remove The Old Kernels</h2> <h3 id=automatically-remove-them>Automatically Remove Them</h3> <p>If you have enabled automatic updates to run on your Ubuntu system, then you can configure the old Linux images and headers to be removed.</p> <p>On Ubuntu 20.04, this would mean enabling or adding the below text to the /etc/apt/apt.conf.d/50unattended-upgrades file.</p> <p><em>NOTE: Before making updates to files in the /etc directory, I would recommend that you create a backup</em> <em>of the file or set up version control, like <a href="https://www.youtube.com/watch?v=dPm8cazYy00" target=_blank>Etckeeper</a>, for this directory.</em></p> <pre><code class=language-bash>// Remove unused automatically installed kernel-related packages
// (kernel images, kernel headers and kernel version locked tools).
Unattended-Upgrade::Remove-Unused-Kernel-Packages &quot;true&quot;;
</code></pre> <h3 id=manual-removal>Manual Removal</h3> <p>Now that you have identified the kernels to be remove, then the next step is to remove them. You can use either apt or dpkg to remove them. My preference is to use apt. Thus the command below would look like the following: </p> <pre><code class=language-bash>iamadmin@thepost:~/ubuntu-automation/utils$ sudo apt-get autoremove --purge linux-image-4.15.0-34-generic \ 
linux-image-4.15.0-38-generic linux-image-4.15.0-39-generic linux-image-4.15.0-42-generic linux-image-4.15.0-43-generic \
linux-image-4.15.0-46-generic linux-image-4.15.0-47-generic linux-image-4.15.0-50-generic linux-image-4.15.0-51-generic \
linux-image-4.15.0-54-generic linux-image-4.15.0-58-generic linux-image-4.15.0-88-generic linux-image-4.15.0-99-generic
</code></pre> <p>You will need to replace the names of each of the packages in provided in the previous section to be used in this section of the code.</p> <p>After entering the command, you may receive a prompt similiar to the one below. </p> <pre><code class=language-bash>Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following packages will be REMOVED:
  linux-headers-4.15.0-36* linux-headers-4.15.0-36-generic* linux-headers-4.15.0-44* linux-headers-4.15.0-44-generic* linux-headers-4.15.0-45*
  linux-headers-4.15.0-45-generic* linux-headers-4.15.0-52*
  linux-headers-4.15.0-52-generic* linux-headers-4.15.0-70* linux-headers-4.15.0-70-generic* linux-headers-4.15.0-72* linux-headers-4.15.0-72-generic*
  linux-headers-4.15.0-74* linux-headers-4.15.0-74-generic*
  linux-headers-4.15.0-76* linux-headers-4.15.0-76-generic* linux-headers-4.15.0-91* linux-headers-4.15.0-91-generic* linux-image-unsigned-4.15.0-70-generic*
0 upgraded, 0 newly installed, 19 to remove and 7 not upgraded.
After this operation, 814 MB disk space will be freed.
Do you want to continue? [Y/n] y
</code></pre> <p>If you do receive such prompt, enter in "Y". </p> <h3 id=additional-removal>Additional Removal</h3> <p>I received a message that some directories were not able to be removed. The reason being is because they were not empty. Thus the package manager would not remove these. </p> <pre><code class=language-bash>rmdir: failed to remove '/lib/modules/4.15.0-70-generic': Directory not empty
</code></pre> <p>It is safe to remove this and any other directories that are listed. To remove them, you will need to run the command: </p> <pre><code class=language-bash>sudo rm -r /lib/modules/4.15.0-70-generic
</code></pre> <p>My experience has been that sometimes the old packages are not automatically removed when Unattended Upgrades runs. I have not quite figured out why this is the case.</p> <h2 id=conclusion>Conclusion</h2> <p>Linux packages take up a lot of space on your system. By making sure you clean them off when they are no longer used, you can make sure that your system runs smoothly and does not become clogged with old junk.</p> <script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script> <ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4218270188842097 data-ad-slot=5189305512 data-ad-format=auto data-full-width-responsive=true></ins> <script>(adsbygoogle = window.adsbygoogle || []).push({});</script> </div><!-- /.blog-main --> <aside class="col-md-4 blog-sidebar"> <div class="p-4 mb-3 bg-light rounded shadow"> <h4 class=font-italic>About Kenny</h4> <p class=mb-0> A software developer that builds and fixes things, and writes about the journey. </p> </div> <div class="p-4 shadow mb-3"> <h4 class=font-italic>Get Into Tech</h4> <p class=mb-0> Are you looking to get into a tech career or role? Check out the <a href=/resources>Resources</a> section for more information. Also check out my <a href="https://www.youtube.com/channel/UC4xp-TEEIAL-4XtMVvfRaQw?sub_confirmation=1" target=_blank> Tech Talk YouTube Channel</a> and <a href="https://www.facebook.com/profile.php?id=100089303142244" target=_blank> Tech Talk Facebook page</a> for video tutorials about software development, web development, and working with tech. </a> </p> </div> <div class="p-4 shadow mb-3"> <h4 class=font-italic>Connect with Me</h4> <ol class=list-unstyled> <li><a target=_blank href=https://github.com/almostengr>Github</a></li> <li><a target=_blank href=https://facebook.com/rhtservicesllc>Home Improvement (Facebook)</a></li> <li><a target=_blank href="https://www.youtube.com/c/RobinsonHandyandTechnologyServices?sub_confirmation=1">Home Improvement (YouTube)</a></li> <li><a target=_blank href=https://instagram.com/almostengr>Instagram</a></li> <li><a target=_blank href="https://www.youtube.com/channel/UCB7rvymUaUbbig3skv2zvCQ?sub_confirmation=1">Kenny Ram Dash Cam</a></li> <li><a target=_blank href=https://stackoverflow.com/users/12875554/almostengr>StackOverflow</a></li> <li><a target=_blank href="https://www.facebook.com/profile.php?id=100089303142244">Tech Talk (Facebook)</a></li> <li><a target=_blank href="https://www.youtube.com/channel/UC4xp-TEEIAL-4XtMVvfRaQw?sub_confirmation=1">Tech Talk (YouTube)</a></li> <li><a target=_blank href=https://www.tiktok.com/@almostengr>TikTok</a></li> <li><a target=_blank href=https://twitter.com/almostengr>Twitter</a></li> </ol> </div> <div class="p-4 shadow mb-3"> <script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script> <ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4218270188842097 data-ad-slot=5189305512 data-ad-format=auto data-full-width-responsive=true></ins> <script>(adsbygoogle = window.adsbygoogle || []).push({});</script> </div> </aside><!-- /.blog-sidebar --> </div><!-- /.row --> </main><!-- /.container --> <footer class="blog-footer bg-dark text-light text-left"> <div class=container> <div> <a class="text-light pr-2" href=/technology>Technology</a> <a class="text-light pr-2" href=/lifestyle>Living</a> <a class="text-light pr-2" href=/projects>Projects</a> <a class="text-light pr-2" href=/resources>Resources</a> <a class="text-light pr-2" href=/services>Services</a> <a class="text-light pr-2" href=/cooking>Food</a> <a class="text-light pr-2" href=/uses>Uses</a> <a class="text-light pr-2" href=/about>About</a> <a class="text-light pr-2" href=/contact>Contact</a> <a class="text-light pr-2" href=/about/privacy>Privacy Policy</a> <a class="text-light pr-2" href=/sitemap.xml>Sitemap</a> </div> <div> <a class="text-light pr-2" target=_blank href=https://facebook.com/rhtservicesllc>Home Improvement (Facebook)</a> <a class="text-light pr-2" target=_blank href="https://www.youtube.com/c/RobinsonHandyandTechnologyServices?sub_confirmation=1">Home Improvement (YouTube)</a> <a class="text-light pr-2" target=_blank href="https://www.facebook.com/profile.php?id=100089303142244">Tech Talk (Facebook)</a> <a class="text-light pr-2" target=_blank href="https://www.youtube.com/channel/UC4xp-TEEIAL-4XtMVvfRaQw?sub_confirmation=1">Tech Talk (YouTube)</a> <a class="text-light pr-2" target=_blank href="https://www.youtube.com/channel/UCB7rvymUaUbbig3skv2zvCQ?sub_confirmation=1">Kenny Ram Dash Cam</a> </div> <div> <a class="text-light pr-2" target=_blank href=https://github.com/almostengr>Github</a> <a class="text-light pr-2" target=_blank href=https://instagram.com/almostengr>Instagram</a> <a class="text-light pr-2" target=_blank href=https://stackoverflow.com/users/12875554/almostengr>StackOverflow</a> <a class="text-light pr-2" target=_blank href=https://www.tiktok.com/@almostengr>TikTok</a> <a class="text-light pr-2" target=_blank href=https://twitter.com/almostengr>Twitter</a> </div> <div>Copyright &copy; 2010-2024 Kenny Robinson</div> <div> Created by <a class=text-light href=https://rhtservices.net target=_blank>Robinson Handy and Technology Services</a> </div> <div> Disclaimer: The opinions expressed here are those of mine and not representative of my employer or affiliates. </div> </div> </footer> </div> <script type=text/javascript src=/js/jquery.min.js></script> <script type=text/javascript src=/js/popper.min.js></script> <script type=text/javascript src=/js/bootstrap.min.js></script> </body> </html>